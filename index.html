<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="icon" type="image/png" href="favicon.png">
<title>Damage Tracker</title>
<style>
body {
	background-color: #000;
	color: #fff;
}

.center {
  margin: auto;
  width: 50%;
  text-align: center;
}

a {
	color: #fff;
}

@media only screen and (max-width: 600px) {
 
  .center {
	  margin: auto;
	  width: 100%;
	}
}
table {
	width: 100%;
	border-collapse: collapse;
}
tr.row0 {
}
tr.row1 {
	background-color: #333;
}
td {
	font: small-caps bold 1em/1.5em Georgia, serif;
	padding-top: .5em;
	padding-bottom: .5em;
}
td.name{
	padding-right: .5em;
	padding-left: .5em;
}
td.hp {
	text-align: right;
	padding-left: 1em;
	padding-right: .5em;
	padding-left: .5em;
}
td.button {
	text-align: center;
	padding-right: .5em;
	padding-left: .5em;
}
button {
	background-color: #000;
	border: 3px solid #fff;
	border-radius: 1em;
	padding: 2px;
}
button > img {
	width: 3em;
	height: 3em;
}
th > input {
  padding: 12px 20px;
  margin: 1.5em 0;
  box-sizing: border-box;
}
th.name {
  width: 75%;
}
th.hp {
  width: 25%;
}
th.name > input {
  width: 100%;
}
th.hp > input {
  width: 100%;
}
th.title {
	font: small-caps bold 2em/2.5em Georgia, serif;
}
</style>
<script>
var n = 0;
var nameTrackers = [];
var hpTrackers = [];
var fullHP = [];

function reduceHP(elId, n, amount) {
	if(hpTrackers[n]>0) {
		hpTrackers[n] -= amount;
		document.getElementById(elId).innerHTML = hpTrackers[n] + " HP";
	}
	if(hpTrackers[n]==0) {
		document.getElementById(elId).parentElement.style.opacity  = "0.2";
	}
}



function updateTable() {
	document.getElementById("figures").innerHTML = "";
	for(i = 0; i < nameTrackers.length; i++) {
		document.getElementById("figures").innerHTML += "<tr class='row"+i%2+"'>"+
			"<td class='name'>" + nameTrackers[i] + "</td>"+
			"<td class='hp' id='"+nameTrackers[i]+"-"+i+"'>" + hpTrackers[i] + " HP</td>"+
			"<td class='button'><button onclick=\"reduceHP('"+nameTrackers[i]+"-"+i+"', "+i+", -1)\"><img src='health-increase.png'/></button></td>" +
			"<td class='button'><button onclick=\"reduceHP('"+nameTrackers[i]+"-"+i+"', "+i+", 1)\"><img src='health-decrease.png'/></button></td>" +
			"</tr>";
	}
}

function addCharacter(name, hp) {
	if(!(name === "")) {
		var cCount = 1;
		for(i=0; i<nameTrackers.length; i++) {
			if(nameTrackers[i] === name) {
				nameTrackers[i] = name + " " + cCount;
				cCount += 1;
			} else if(nameTrackers[i].startsWith(name)) {
				cCount += 1;
			}
		}
		if(cCount > 1)
			nameTrackers.push(name + " " + cCount);
		else
			nameTrackers.push(name);
		
		hpTrackers.push(hp);
		fullHP.push(hp);
		updateTable();
		n += 1;
	}
}

function copyToClipboard(text) {
  const listener = function(ev) {
    ev.preventDefault();
    ev.clipboardData.setData('text/plain', text);
  };
  document.addEventListener('copy', listener);
  document.execCommand('copy');
  document.removeEventListener('copy', listener);
}

function copyURL() {
	let wl = window.location;
	var baseURL = wl.protocol+wl.host+wl.pathname;
	copyToClipboard(baseURL + "?" + "names="+encodeURIComponent(nameTrackers)+"&hps="+encodeURIComponent(hpTrackers));
	window.alert("URL copied!");
}

function fullReset() {
	nameTrackers = [];
	hpTrackers = [];
	n = 0;
	document.getElementById("figures").innerHTML = "";
}

function resetHP() {
	hpTrackers = [...fullHP];
	for(i=0; i<n; i++) {
		document.getElementById(nameTrackers[i]+"-"+i).parentElement.style.opacity  = "1";
		document.getElementById(nameTrackers[i]+"-"+i).innerHTML = hpTrackers[i] + " HP";
	}
}
</script>
</head>
<body>

<div class="center">
	<table class="ctable">
	<tbody><tr><th colspan="4" class="title">Roster</th></tr></tbody>
	<tbody id="figures">
	</tbody>
	<tbody>
		<form onsubmit="return false">
		<tr>
		<th class="name"><input id="newName" type="text" placeholder="Unit name..." /></th>
		<th class="hp"><input id="newHP" type="number" value="10" /></th>
		<th class="button" colspan="2"><button class="add" onclick="addCharacter(document.getElementById('newName').value, document.getElementById('newHP').value)" type="submit"><img src='up-card.png'/></button></th><th></th>
		</form>
	</tr>
	</tbody>
	</table>

	<script>
	let searchParams = new URLSearchParams(window.location.search)

	if(searchParams.has('names') && searchParams.has('hps')) {
		var names = searchParams.get('names').split(',')
		var hps = searchParams.get('hps').split(',').map(Number)
		if(names.length === hps.length) {
			for(i in names) {
				addCharacter(names[i], hps[i]);
			}
		}
	}
	</script>
	&nbsp;
	
	<table class="ctable">
	<tbody>
	<tr>
		<th class="button"><button class="add" onclick="fullReset()"><img src='scroll-unfurled.png'/></button></th>
		<th class="button"><button class="add" onclick="resetHP()"><img src='anticlockwise-rotation.png'/></button></th>
		<th class="button"><button class="add" onclick="copyURL()"><img src='wireframe-globe.png'/></button></th>
		<th class="button"><button class="add" onclick="window.location.href='https://github.com/markblokpoel/hptracker'"><img src='help.png'/></button></th>

	</tr>
	</tbody>
	</table>
</div>

<div class="center">
	<p>Copyright Mark Blokpoel. Icons by <a href="https://game-icons.net/">https://game-icons.net/</a>
	<a href="http://creativecommons.org/licenses/by/3.0/">CC BY 3.0</a>.</p>
</div>
</body>
</html>
