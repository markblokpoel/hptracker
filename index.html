<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="icon" type="image/png" href="favicon.png">
<title>Damage Tracker</title>
<style>
body {
	background-color: #000;
	color: #fff;
}

.center {
  margin: auto;
  width: 50%;
  text-align: center;
}

a {
	color: #fff;
}

@media only screen and (max-width: 600px) {

  .center {
	  margin: auto;
	  width: 100%;
	}
}
table {
	width: 100%;
	border-collapse: collapse;
}
tr.row0 {
}
tr.row1 {
	background-color: #333;
}
tr.dead {
  opacity: 0.2;
}
tr.alive {
  opacity: 1.0;
}
td {
	font: small-caps bold 1em/1.5em Georgia, serif;
	padding-top: .5em;
	padding-bottom: .5em;
}
td.name{
	padding-right: .5em;
	padding-left: .5em;
}
td.hp {
	text-align: right;
	padding-left: 1em;
	padding-right: .5em;
	padding-left: .5em;
}
td.button {
	text-align: center;
	padding-right: .5em;
	padding-left: .5em;
}
button {
	background-color: #000;
	border: 3px solid #fff;
	border-radius: 1em;
	padding: 2px;
}
button > img {
	width: 3em;
	height: 3em;
}
.groupheader{
  background-color: #666;
  text-align: center;
}
th > input {
  padding: 12px 20px;
  margin: 1.5em 0;
  box-sizing: border-box;
}
th.name {
  width: 70%;
}
th.hp {
  width: 30%;
}
th.name > input {
  width: 100%;
}
th.hp > input {
  width: 100%;
}
th.title {
	font: small-caps bold 2em/2.5em Georgia, serif;
}
</style>
<script>
class Unit {
  constructor(name, id, hp, group = " default") {
    this.name = name;
    this.id = id;
    this.group = group;
    this.fullHP = hp;
    this.hp = hp;
  }

  reduceHP(amount) {
    if(this.hp - amount >= 0)
      this.hp -= amount;
  }

  resetHP() {
    this.hp = this.fullHP;
  }
}

class Roster {
  constructor() {
    this.units = [];
  }

  addUnit(unit) {
    this.units.push(unit);
  }

  nextUnitId(name) {
    var id = 1;
    var unit;
    for(unit of this.units) {
      if(unit.name === name)
        id += 1;
    }
    return id;
  }

  reduceHP(name, id, amount) {
    console.log(unit.name + unit.id);
    for(unit of this.units) {
      if(unit.name === name && unit.id == id) {
        unit.reduceHP(amount);
      }
    }
  }

  resetHP() {
    for(unit of this.units)
      unit.resetHP();
  }

  get getUnitsByGroup() {
    var byGroup = new Map();
    var unit;
    for(unit of this.units) {
      if(byGroup.has(unit.group)) {
        byGroup.get(unit.group).push(unit);
      } else {
        byGroup.set(unit.group, [unit]);
      }
    }
    return byGroup;
  }

  get getUniqueGroups() {
    var groups = [];
    var unit;
    for(unit of this.units) {
      if(!groups.includes(unit.group))
        groups.push(unit.group);
    }
    return groups;
  }

  get getNames() {
    var names = [];
    var unit;
    for(unit of this.units) {
      names.push(unit.name);
    }
    return names;
  }

  get getHPs() {
    var hps = [];
    var unit;
    for(unit of this.units) {
      hps.push(unit.hp);
    }
    return hps;
  }

  get getGroups() {
    var groups = [];
    var unit;
    for(unit of this.units) {
      groups.push(unit.group);
    }
    return groups;
  }
}

var roster = new Roster();


function updateTable() {
	document.getElementById("figures").innerHTML = "";
  let unitsByGroup = roster.getUnitsByGroup;
	for(group of roster.getUniqueGroups.sort()) {
    if(!(group === " default")) {
      document.getElementById("figures").innerHTML +=
        "<tr class='groupheader'><td colspan='4'>" + group + "</td></tr>";
    }
    var r = 0;
    for(unit of unitsByGroup.get(group)) {
      document.getElementById("figures").innerHTML +=
      "<tr class='row"+r%2+" "+(unit.hp===0? "dead" : "alive")+"'>"+
			"<td class='name'>" + unit.name + unit.id + "</td>"+
			"<td class='hp'>" + unit.hp + " HP</td>"+
			"<td class='button'><button onclick=\"reduceHP('"+unit.name+"', '"+unit.id+"', -1)\"><img src='health-increase.png'/></button></td>" +
			"<td class='button'><button onclick=\"reduceHP('"+unit.name+"', '"+unit.id+"', 1)\"><img src='health-decrease.png'/></button></td>" +
			"</tr>";
      r += 1;
    }
	}
}


function reduceHP(name, id, amount) {
  roster.reduceHP(name, id, amount);
  updateTable();
}

function addCharacter(name, hp, group) {
  if(!(name === "")) {
    if(!(group === "")) {
      roster.addUnit(new Unit(name, roster.nextUnitId(name), hp, group));
    } else {
      roster.addUnit(new Unit(name, roster.nextUnitId(name), hp));
    }
  }
  updateTable();
}

function copyToClipboard(text) {
  const listener = function(ev) {
    ev.preventDefault();
    ev.clipboardData.setData('text/plain', text);
  };
  document.addEventListener('copy', listener);
  document.execCommand('copy');
  document.removeEventListener('copy', listener);
}

function copyURL() {
	let wl = window.location;
	var baseURL = wl.protocol+wl.host+wl.pathname;
	copyToClipboard(baseURL + "?" + "names="+roster.getNames.map(encodeURIComponent)+"&groups="+roster.getGroups.map(encodeURIComponent)+"&hps="+roster.getHPs.map(encodeURIComponent));
	window.alert("URL copied!");
}

function fullReset() {
	roster = new Roster();
  updateTable();
}

function resetHP() {
	roster.resetHP();
  updateTable();
}
</script>
</head>
<body>

<div class="center">
	<table class="ctable">
	<tbody><tr><th colspan="4" class="title">Roster</th></tr></tbody>
	<tbody id="figures">
	</tbody>
	<tbody>
		<form onsubmit="return false">
		<tr>
		<th class="name"><input id="newName" type="text" placeholder="Unit name..." /></th>
		<th class="hp"><input id="newHP" type="number" value="10" /></th>
    <th class="group"><input id="newGroup" type="text" placeholder="Group name..." /></th>
		<th class="button"><button class="add" onclick="addCharacter(document.getElementById('newName').value, document.getElementById('newHP').value, document.getElementById('newGroup').value)" type="submit"><img src='up-card.png'/></button></th><th></th>
		</form>
	</tr>
	</tbody>
	</table>

	<script>
	let searchParams = new URLSearchParams(window.location.search)

	if(searchParams.has('names') && searchParams.has('groups') && searchParams.has('hps')) {
		var names = searchParams.get('names').split(',')
    var groups = searchParams.get('groups').split(',')
		var hps = searchParams.get('hps').split(',').map(Number)
		if(names.length == hps.length && hps.length == groups.length) {
			for(i in names) {
				addCharacter(names[i], hps[i], groups[i]);
			}
		}
	}
	</script>
	&nbsp;

	<table class="ctable">
	<tbody>
	<tr>
		<th class="button"><button class="add" onclick="fullReset()"><img src='scroll-unfurled.png'/></button></th>
		<th class="button"><button class="add" onclick="resetHP()"><img src='anticlockwise-rotation.png'/></button></th>
		<th class="button"><button class="add" onclick="copyURL()"><img src='wireframe-globe.png'/></button></th>
		<th class="button"><button class="add" onclick="window.location.href='https://github.com/markblokpoel/hptracker'"><img src='help.png'/></button></th>

	</tr>
	</tbody>
	</table>
</div>

<div class="center">
	<p>v0.2.0</p><p>Copyright Mark Blokpoel. Icons by <a href="https://game-icons.net/">https://game-icons.net/</a>
	<a href="http://creativecommons.org/licenses/by/3.0/">CC BY 3.0</a>.</p>
</div>
</body>
</html>
